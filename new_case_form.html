<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>New Case - Dental Practice</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #BCDDE4;
      min-height: 100vh;
      padding: 20px;
    }

    .app-container {
      background: #EDEDED;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      max-width: 1000px;
      margin: 0 auto;
      animation: slideUp 0.6s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      background: linear-gradient(135deg, #197CAE 0%, #003049 100%);
      padding: 30px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-info h1 {
      font-size: 28px;
      margin-bottom: 5px;
    }

    .header-info p {
      opacity: 0.9;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      white-space: nowrap;
    }

    .btn-primary {
      background: #FFCB05;
      color: #003049;
    }

    .btn-primary:hover {
      background: #e6b405;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .btn-draft {
      background: #FFC107;
      color: #003049;
    }

    .btn-draft:hover {
      background: #FFB300;
      transform: translateY(-2px);
    }

    .btn-reset {
      background: #f44336;
      color: white;
    }

    .btn-reset:hover:not(:disabled) {
      background: #d32f2f;
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .content {
      padding: 40px 30px;
    }

    .form-section {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .form-section:hover {
      border-color: #197CAE;
      box-shadow: 0 10px 25px rgba(0, 48, 73, 0.1);
    }

    .section-title {
      font-size: 20px;
      color: #003049;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #BCDDE4;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      margin-bottom: 8px;
      font-weight: 600;
      color: #003049;
      font-size: 14px;
    }

    .required {
      color: #d32f2f;
    }

    .custom-select {
      position: relative;
    }

    .custom-select-input {
      width: 100%;
      padding: 12px 40px 12px 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
      font-family: inherit;
      background: white;
      cursor: pointer;
    }

    .custom-select-arrow {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #666;
      transition: transform 0.3s ease;
    }

    .custom-select.open .custom-select-arrow {
      transform: translateY(-50%) rotate(180deg);
    }

    .custom-select-option.new-patient {
      background: #e8f5e8;
      position: relative;
    }

    .custom-select-option.new-patient::after {
      content: "NEW";
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: #28a745;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
    }

    .custom-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #197CAE;
      border-radius: 10px;
      margin-top: 5px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .custom-select.open .custom-select-dropdown {
      display: block;
    }

    .custom-select-option {
      padding: 12px 15px;
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 14px;
    }

    .custom-select-option:hover {
      background: #e3f2fd;
    }

    .custom-select-option.selected {
      background: #197CAE;
      color: white;
    }

    .custom-select-option.hidden {
      display: none;
    }

    .custom-select-input:focus {
      outline: none;
      border-color: #197CAE;
      box-shadow: 0 0 0 3px rgba(25, 124, 174, 0.1);
    }

    .custom-select.disabled-select .custom-select-input {
      background-color: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }

    .custom-select.disabled-select .custom-select-arrow {
      color: #ccc;
    }

    .custom-select.disabled-select .custom-select-dropdown {
      display: none !important;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .form-group select:disabled {
      background-color: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #197CAE;
      box-shadow: 0 0 0 3px rgba(25, 124, 174, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .form-group input[type="date"] {
      color: #003049;
    }

    .form-group input[type="number"] {
      text-align: right;
    }

    .input-group {
      position: relative;
    }

    .input-prefix {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      font-weight: 500;
    }

    .input-group input {
      padding-left: 35px;
    }

    .priority-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .priority-option {
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
    }

    .priority-option.selected {
      border-color: #197CAE;
      background: #197CAE;
      color: white;
    }

    .priority-normal { border-color: #2196f3; }
    .priority-normal.selected { background: #2196f3; }
    .priority-urgent { border-color: #f44336; }
    .priority-urgent.selected { background: #f44336; }

    .tooth-chart-container {
      background: white;
      border: 2px solid #197CAE;
      border-radius: 15px;
      padding: 15px;
      margin-top: 15px;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
    }

    .tooth-chart {
      min-width: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .tooth-row {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    .tooth-row.upper {
      margin-bottom: 30px;
    }

    .teeth-group {
      display: flex;
      gap: 5px;
    }

    .midline {
      font-size: 24px;
      color: #197CAE;
      font-weight: bold;
      margin: 0 15px;
    }

    .tooth-number {
      width: 35px;
      height: 35px;
      border: 2px solid #ddd;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.3s ease;
      background: white;
    }

    .tooth-number:hover {
      border-color: #197CAE;
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(25, 124, 174, 0.3);
    }

    .tooth-number.selected {
      background: #197CAE;
      color: white;
      border-color: #197CAE;
      transform: scale(1.05);
    }

    .selected-teeth {
      margin-top: 15px;
      padding: 10px 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #197CAE;
    }

    .file-upload-area {
      background: white;
      border: 2px dashed #197CAE;
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-upload-area:hover {
      background: #f0f8ff;
      border-color: #003049;
      transform: translateY(-2px);
    }

    .file-upload-icon {
      font-size: 50px;
      margin-bottom: 15px;
      color: #197CAE;
    }

    .file-upload-area h3 {
      color: #003049;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .uploaded-files-list {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
    }

    .uploaded-file {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #197CAE;
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .file-icon {
      font-size: 20px;
    }

    .file-details {
      display: flex;
      flex-direction: column;
    }

    .file-name {
      font-weight: 500;
      color: #003049;
    }

    .file-size {
      font-size: 12px;
      color: #666;
    }

    .file-remove {
      background: #f44336;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .file-remove:hover {
      background: #d32f2f;
      transform: translateY(-1px);
    }

    .form-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-top: 2px solid #BCDDE4;
      margin-top: 20px;
      gap: 15px;
      flex-wrap: wrap;
    }

    .validation-error {
      color: #d32f2f;
      font-size: 12px;
      margin-top: 5px;
    }

    .info-box {
      background: #e3f2fd;
      color: #1976d2;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #1976d2;
    }

    .auto-save {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #e8f5e8;
      color: #388e3c;
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }

    .auto-save.show {
      opacity: 1;
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header {
        padding: 20px;
      }

      .header-info h1 {
        font-size: 24px;
      }

      .content {
        padding: 20px 15px;
      }

      .form-section {
        padding: 20px 15px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .priority-selector {
        grid-template-columns: 1fr;
      }

      .tooth-chart-container {
        padding: 10px;
        border-radius: 10px;
      }

      .tooth-chart {
        min-width: 500px;
      }

      .tooth-number {
        width: 28px;
        height: 28px;
        font-size: 10px;
      }

      .midline {
        font-size: 18px;
        margin: 0 8px;
      }

      .teeth-group {
        gap: 3px;
      }

      .form-navigation {
        flex-direction: column;
        align-items: stretch;
      }

      .form-navigation .button-group {
        display: flex;
        gap: 10px;
        width: 100%;
      }

      .form-navigation .button-group .btn {
        flex: 1;
      }
    }

    @media (max-width: 480px) {
      .app-container {
        border-radius: 0;
      }

      .tooth-chart {
        min-width: 400px;
      }

      .tooth-number {
        width: 24px;
        height: 24px;
        font-size: 9px;
      }

      .teeth-group {
        gap: 2px;
      }

      .midline {
        font-size: 16px;
        margin: 0 5px;
      }
    }

    .btn-add-patient {
      background: #28a745;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      margin-top: 8px;
      width: 100%;
      transition: all 0.3s ease;
    }

    .btn-add-patient:hover {
      background: #218838;
      transform: translateY(-1px);
    }

    .btn-add-patient:disabled {
      background: #ccc !important;
      cursor: not-allowed !important;
      transform: none !important;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background-color: #EDEDED;
      margin: 20px auto;
      padding: 0;
      width: 90%;
      max-width: 800px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      background: linear-gradient(135deg, #197CAE 0%, #003049 100%);
      padding: 25px 30px;
      color: white;
      border-radius: 20px 20px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 24px;
      margin: 0;
    }

    .modal-header p {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 5px;
    }

    .close-modal {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
      opacity: 0.8;
      transition: opacity 0.3s;
    }

    .close-modal:hover {
      opacity: 1;
    }

    .modal-body {
      padding: 30px;
    }

    .modal-form-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .modal-form-section:hover {
      border-color: #197CAE;
      box-shadow: 0 5px 15px rgba(0, 48, 73, 0.1);
    }

    .modal-form-section h3 {
      color: #003049;
      font-size: 18px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 12px;
      border-bottom: 2px solid #EDEDED;
    }

    .modal-form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .modal-form-group {
      display: flex;
      flex-direction: column;
    }

    .modal-form-group label {
      margin-bottom: 6px;
      font-weight: 600;
      color: #003049;
      font-size: 13px;
    }

    .modal-form-group input,
    .modal-form-group select,
    .modal-form-group textarea {
      padding: 10px 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .modal-form-group input:focus,
    .modal-form-group select:focus,
    .modal-form-group textarea:focus {
      outline: none;
      border-color: #197CAE;
      box-shadow: 0 0 0 3px rgba(25, 124, 174, 0.1);
    }

    .modal-form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .char-counter {
      color: #197CAE;
      font-size: 11px;
      text-align: right;
      margin-top: 4px;
    }

    .modal-alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }

    .modal-alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-color: #17a2b8;
    }

    .modal-alert-success {
      background: #d4edda;
      color: #155724;
      border-color: #28a745;
      display: none;
    }

    .modal-footer {
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 20px 0 0;
      border-top: 2px solid #EDEDED;
      margin-top: 20px;
    }

    .modal-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 120px;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, #197CAE 0%, #003049 100%);
      color: white;
    }

    .modal-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(25, 124, 174, 0.4);
    }

    .modal-btn-secondary {
      background: #EDEDED;
      color: #003049;
      border: 2px solid #197CAE;
    }

    .modal-btn-secondary:hover {
      background: #BCDDE4;
      transform: translateY(-1px);
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        margin: 10px auto;
      }

      .modal-body {
        padding: 20px;
      }

      .modal-form-grid {
        grid-template-columns: 1fr;
      }

      .modal-footer {
        flex-direction: column;
        align-items: stretch;
      }

      .modal-btn {
        width: 100%;
      }
    }

    .button-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="auto-save" id="autoSave">✅ Draft saved automatically</div>

  <div class="app-container">
    <div class="header">
      <div class="header-info">
        <h1>Create New Case</h1>
        <p>Complete the form to create a new dental laboratory case</p>
      </div>
      <div class="header-actions">
        <a href="#" class="btn btn-secondary" onclick="goBack()">← Cancel</a>
      </div>
    </div>

    <div class="content">
      <form id="newCaseForm">
        <!-- Patient & Doctor Information -->
        <div class="form-section">
          <div class="section-title">
            <span>👤</span> Patient & Doctor Information
          </div>
          <div class="info-box">
            💡 <strong>Tip:</strong> Select a doctor first to see their associated patients and practices.
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="doctorName">Doctor Name <span class="required">*</span></label>
              <div class="custom-select" id="doctorSelect">
                <input type="text" class="custom-select-input" id="doctorName" placeholder="Select or type doctor name" required oninput="filterDropdown('doctorSelect'); checkDoctorSelection();" onclick="toggleDropdown('doctorSelect')">
                <span class="custom-select-arrow">▼</span>
                <div class="custom-select-dropdown">
                  <div class="custom-select-option" onclick="selectOption('doctorSelect', 'Dr. John Smith')">Dr. John Smith</div>
                  <div class="custom-select-option" onclick="selectOption('doctorSelect', 'Dr. Mary Johnson')">Dr. Mary Johnson</div>
                  <div class="custom-select-option" onclick="selectOption('doctorSelect', 'Dr. Robert Brown')">Dr. Robert Brown</div>
                  <div class="custom-select-option" onclick="selectOption('doctorSelect', 'Dr. Sarah Davis')">Dr. Sarah Davis</div>
                  <div class="custom-select-option" onclick="selectOption('doctorSelect', 'Dr. Michael Wilson')">Dr. Michael Wilson</div>
                  <div class="custom-select-option" onclick="selectOption('doctorSelect', 'Dr. Jennifer Martinez')">Dr. Jennifer Martinez</div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="patientName">Patient <span class="required">*</span></label>
              <div class="custom-select disabled-select" id="patientSelect">
                <input type="text" class="custom-select-input" id="patientName" placeholder="First select a doctor" required disabled oninput="filterDropdown('patientSelect')" onclick="toggleDropdown('patientSelect')">
                <span class="custom-select-arrow">▼</span>
                <div class="custom-select-dropdown">
                  <div class="custom-select-option" onclick="selectOption('patientSelect', 'John Smith - DOB: 1985-03-15')">John Smith - DOB: 1985-03-15</div>
                  <div class="custom-select-option" onclick="selectOption('patientSelect', 'Mary Johnson - DOB: 1978-08-22')">Mary Johnson - DOB: 1978-08-22</div>
                  <div class="custom-select-option" onclick="selectOption('patientSelect', 'Robert Brown - DOB: 1965-11-30')">Robert Brown - DOB: 1965-11-30</div>
                  <div class="custom-select-option" onclick="selectOption('patientSelect', 'Sarah Davis - DOB: 1992-06-18')">Sarah Davis - DOB: 1992-06-18</div>
                  <div class="custom-select-option" onclick="selectOption('patientSelect', 'Michael Wilson - DOB: 1988-12-05')">Michael Wilson - DOB: 1988-12-05</div>
                  <div class="custom-select-option" onclick="selectOption('patientSelect', 'Jennifer Martinez - DOB: 1975-07-14')">Jennifer Martinez - DOB: 1975-07-14</div>
                </div>
              </div>
              <button type="button" class="btn-add-patient" id="addPatientBtn" onclick="openPatientModal()" disabled style="opacity: 0.5; cursor: not-allowed;">➕ Add New Patient</button>
            </div>
            <div class="form-group">
              <label for="practiceName">Practice <span class="required">*</span></label>
              <div class="custom-select disabled-select" id="practiceSelect">
                <input type="text" class="custom-select-input" id="practiceName" placeholder="First select a doctor" required disabled oninput="filterDropdown('practiceSelect')" onclick="toggleDropdown('practiceSelect')">
                <span class="custom-select-arrow">▼</span>
                <div class="custom-select-dropdown">
                  <div class="custom-select-option" onclick="selectOption('practiceSelect', 'Downtown Dental Center')">Downtown Dental Center</div>
                  <div class="custom-select-option" onclick="selectOption('practiceSelect', 'Family Dentistry Associates')">Family Dentistry Associates</div>
                  <div class="custom-select-option" onclick="selectOption('practiceSelect', 'Smile Solutions Clinic')">Smile Solutions Clinic</div>
                  <div class="custom-select-option" onclick="selectOption('practiceSelect', 'Advanced Dental Care')">Advanced Dental Care</div>
                  <div class="custom-select-option" onclick="selectOption('practiceSelect', 'Comfort Dental Group')">Comfort Dental Group</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Case Details -->
        <div class="form-section">
          <div class="section-title">
            <span>🦷</span> Case Details & Specifications
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="itemType">Item Type <span class="required">*</span></label>
              <div class="custom-select" id="itemTypeSelect">
                <input type="text" class="custom-select-input" id="itemType" placeholder="Select or type item type" required oninput="filterDropdown('itemTypeSelect')" onclick="toggleDropdown('itemTypeSelect')">
                <span class="custom-select-arrow">▼</span>
                <div class="custom-select-dropdown">
                  <div class="custom-select-option" onclick="selectOption('itemTypeSelect', 'Crown')">Crown</div>
                  <div class="custom-select-option" onclick="selectOption('itemTypeSelect', 'Bridge')">Bridge</div>
                  <div class="custom-select-option" onclick="selectOption('itemTypeSelect', 'Denture (Full)')">Denture (Full)</div>
                  <div class="custom-select-option" onclick="selectOption('itemTypeSelect', 'Denture (Partial)')">Denture (Partial)</div>
                  <div class="custom-select-option" onclick="selectOption('itemTypeSelect', 'Orthodontic Appliance')">Orthodontic Appliance</div>
                  <div class="custom-select-option" onclick="selectOption('itemTypeSelect', 'Implant Crown')">Implant Crown</div>
                  <div class="custom-select-option" onclick="selectOption('itemTypeSelect', 'Inlay/Onlay')">Inlay/Onlay</div>
                  <div class="custom-select-option" onclick="selectOption('itemTypeSelect', 'Veneer')">Veneer</div>
                  <div class="custom-select-option" onclick="selectOption('itemTypeSelect', 'Night Guard')">Night Guard</div>
                  <div class="custom-select-option" onclick="selectOption('itemTypeSelect', 'Retainer')">Retainer</div>
                  <div class="custom-select-option" onclick="selectOption('itemTypeSelect', 'Temporary Crown')">Temporary Crown</div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="material">Material</label>
              <select id="material">
                <option value="">Select Material</option>
                <option value="1">Porcelain</option>
                <option value="2">Zirconia</option>
                <option value="3">Metal (Gold)</option>
                <option value="4">Metal (Titanium)</option>
                <option value="5">Composite</option>
                <option value="6">Ceramic</option>
                <option value="7">Lithium Disilicate</option>
              </select>
            </div>
            <div class="form-group">
              <label for="shade">Shade Selection</label>
              <div class="custom-select" id="shadeSelect">
                <input type="text" class="custom-select-input" id="shade" placeholder="Select or type shade" oninput="filterDropdown('shadeSelect')" onclick="toggleDropdown('shadeSelect')">
                <span class="custom-select-arrow">▼</span>
                <div class="custom-select-dropdown">
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'A1 - Light Reddish Brown')">A1 - Light Reddish Brown</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'A2 - Reddish Brown')">A2 - Reddish Brown</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'A3 - Dark Reddish Brown')">A3 - Dark Reddish Brown</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'A3.5 - Dark Reddish Brown')">A3.5 - Dark Reddish Brown</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'A4 - Dark Reddish Brown')">A4 - Dark Reddish Brown</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'B1 - Light Reddish Yellow')">B1 - Light Reddish Yellow</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'B2 - Reddish Yellow')">B2 - Reddish Yellow</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'B3 - Dark Reddish Yellow')">B3 - Dark Reddish Yellow</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'B4 - Dark Reddish Yellow')">B4 - Dark Reddish Yellow</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'C1 - Light Gray')">C1 - Light Gray</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'C2 - Gray')">C2 - Gray</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'C3 - Dark Gray')">C3 - Dark Gray</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'C4 - Dark Gray')">C4 - Dark Gray</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'D2 - Reddish Gray')">D2 - Reddish Gray</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'D3 - Dark Reddish Gray')">D3 - Dark Reddish Gray</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'D4 - Dark Reddish Gray')">D4 - Dark Reddish Gray</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'Bleach 1')">Bleach 1</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'Bleach 2')">Bleach 2</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'Bleach 3')">Bleach 3</div>
                  <div class="custom-select-option" onclick="selectOption('shadeSelect', 'Bleach 4')">Bleach 4</div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Priority Level</label>
              <div class="priority-selector">
                <div class="priority-option priority-normal selected" onclick="selectPriority(2, this)">
                  <div>🔵 Normal</div>
                  <small>Regular</small>
                </div>
                <div class="priority-option priority-urgent" onclick="selectPriority(4, this)">
                  <div>🔴 Urgent</div>
                  <small>Rush</small>
                </div>
              </div>
              <input type="hidden" id="priorityLevel" value="2">
            </div>
          </div>
        </div>

        <!-- Tooth Selection -->
        <div class="form-section">
          <div class="section-title">
            <span>🦷</span> Tooth Selection
          </div>
          <div class="form-group">
            <label>Select Affected Teeth <span class="required">*</span></label>
            <div class="info-box">
              Click on the teeth that need treatment. Scroll horizontally on mobile to see all teeth.
            </div>
            <div class="tooth-chart-container">
              <div class="tooth-chart">
                <div class="tooth-row upper">
                  <div class="teeth-group">
                    <div class="tooth-number" onclick="toggleTooth(18, this)">18</div>
                    <div class="tooth-number" onclick="toggleTooth(17, this)">17</div>
                    <div class="tooth-number" onclick="toggleTooth(16, this)">16</div>
                    <div class="tooth-number" onclick="toggleTooth(15, this)">15</div>
                    <div class="tooth-number" onclick="toggleTooth(14, this)">14</div>
                    <div class="tooth-number" onclick="toggleTooth(13, this)">13</div>
                    <div class="tooth-number" onclick="toggleTooth(12, this)">12</div>
                    <div class="tooth-number" onclick="toggleTooth(11, this)">11</div>
                  </div>
                  <div class="midline">|</div>
                  <div class="teeth-group">
                    <div class="tooth-number" onclick="toggleTooth(21, this)">21</div>
                    <div class="tooth-number" onclick="toggleTooth(22, this)">22</div>
                    <div class="tooth-number" onclick="toggleTooth(23, this)">23</div>
                    <div class="tooth-number" onclick="toggleTooth(24, this)">24</div>
                    <div class="tooth-number" onclick="toggleTooth(25, this)">25</div>
                    <div class="tooth-number" onclick="toggleTooth(26, this)">26</div>
                    <div class="tooth-number" onclick="toggleTooth(27, this)">27</div>
                    <div class="tooth-number" onclick="toggleTooth(28, this)">28</div>
                  </div>
                </div>
                
                <div class="tooth-row lower">
                  <div class="teeth-group">
                    <div class="tooth-number" onclick="toggleTooth(48, this)">48</div>
                    <div class="tooth-number" onclick="toggleTooth(47, this)">47</div>
                    <div class="tooth-number" onclick="toggleTooth(46, this)">46</div>
                    <div class="tooth-number" onclick="toggleTooth(45, this)">45</div>
                    <div class="tooth-number" onclick="toggleTooth(44, this)">44</div>
                    <div class="tooth-number" onclick="toggleTooth(43, this)">43</div>
                    <div class="tooth-number" onclick="toggleTooth(42, this)">42</div>
                    <div class="tooth-number" onclick="toggleTooth(41, this)">41</div>
                  </div>
                  <div class="midline">|</div>
                  <div class="teeth-group">
                    <div class="tooth-number" onclick="toggleTooth(31, this)">31</div>
                    <div class="tooth-number" onclick="toggleTooth(32, this)">32</div>
                    <div class="tooth-number" onclick="toggleTooth(33, this)">33</div>
                    <div class="tooth-number" onclick="toggleTooth(34, this)">34</div>
                    <div class="tooth-number" onclick="toggleTooth(35, this)">35</div>
                    <div class="tooth-number" onclick="toggleTooth(36, this)">36</div>
                    <div class="tooth-number" onclick="toggleTooth(37, this)">37</div>
                    <div class="tooth-number" onclick="toggleTooth(38, this)">38</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="selected-teeth" id="selectedTeeth" style="display: none;">
              <strong>Selected Teeth:</strong> <span id="selectedTeethList"></span>
            </div>
            <input type="hidden" id="toothNumbers" required>
          </div>
        </div>

        <!-- Timeline & Pricing -->
        <div class="form-section">
          <div class="section-title">
            <span>💰</span> Timeline & Pricing
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="deadline">Deadline Date</label>
              <input type="date" id="deadline">
            </div>
            <div class="form-group">
              <label for="price">Price</label>
              <div class="input-group">
                <span class="input-prefix">$</span>
                <input type="number" id="price" step="0.01" placeholder="0.00">
              </div>
            </div>
            <div class="form-group">
              <label for="paymentStatus">Payment Status</label>
              <select id="paymentStatus">
                <option value="">Select Payment Status</option>
                <option value="1">Pending Payment</option>
                <option value="2">Paid in Full</option>
                <option value="3">Partial Payment</option>
                <option value="4">Insurance Processing</option>
                <option value="5">Overdue</option>
                <option value="6">Payment Plan</option>
                <option value="7">Cancelled</option>
                <option value="8">Refunded</option>
              </select>
            </div>
          </div>
        </div>

        <!-- File Uploads -->
        <div class="form-section">
          <div class="section-title">
            <span>📎</span> Case Documentation & Files
          </div>
          
          <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
            <div class="file-upload-icon">📁</div>
            <h3>Drop files here or click to browse</h3>
          </div>
          <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.pdf,.dcm,.dicom,.doc,.docx" style="display: none;" onchange="handleFileUpload(this)">
          
          <div id="uploadedFiles" class="uploaded-files-list"></div>
        </div>

        <!-- Notes & Instructions -->
        <div class="form-section">
          <div class="section-title">
            <span>📝</span> Notes & Special Instructions
          </div>
          <div class="form-group">
            <label for="notes">Special Instructions</label>
            <textarea id="notes" placeholder="Enter any special instructions, patient preferences, or clinical notes..."></textarea>
          </div>
          <div class="form-group">
            <label for="deliveryAddress">Custom Delivery Address (Optional)</label>
            <textarea id="deliveryAddress" placeholder="If different from the practice address, enter custom delivery address..."></textarea>
          </div>
        </div>

        <!-- Form Navigation -->
        <div class="form-navigation">
          <div>
            <small style="color: #666;">All fields marked with <span class="required">*</span> are required</small>
          </div>
          <div class="button-group">
            <button type="button" class="btn btn-draft" onclick="saveDraft()">💾 Save Draft</button>
            <button type="button" class="btn btn-reset" id="resetBtn" onclick="resetForm()" disabled>Reset Page</button>
            <button type="submit" class="btn btn-primary">Create Case</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Patient Modal -->
  <div id="patientModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h2>➕ Add New Patient</h2>
          <p>Create a new patient profile with complete information</p>
        </div>
        <button class="close-modal" onclick="closePatientModal()">&times;</button>
      </div>

      <div class="modal-body">
        <div id="modalSuccessAlert" class="modal-alert modal-alert-success">
          ✅ New patient profile created successfully!
        </div>

        <div id="modalInfoAlert" class="modal-alert modal-alert-info">
          💡 Fill in the patient information below. Only first and last name are required fields.
        </div>

        <form id="newPatientModalForm">
          <!-- Basic Information -->
          <div class="modal-form-section">
            <h3>👤 Basic Information</h3>
            <div class="modal-form-grid">
              <div class="modal-form-group">
                <label for="modalFirstName">First Name <span class="required">*</span></label>
                <input type="text" id="modalFirstName" placeholder="Enter first name" required>
              </div>

              <div class="modal-form-group">
                <label for="modalLastName">Last Name <span class="required">*</span></label>
                <input type="text" id="modalLastName" placeholder="Enter last name" required>
              </div>

              <div class="modal-form-group">
                <label for="modalDateOfBirth">Date of Birth</label>
                <input type="date" id="modalDateOfBirth">
              </div>

              <div class="modal-form-group">
                <label for="modalGender">Gender</label>
                <select id="modalGender">
                  <option value="">Select gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                  <option value="prefer-not-to-say">Prefer not to say</option>
                </select>
              </div>

              <div class="modal-form-group">
                <label for="modalToothShade">Natural Tooth Shade</label>
                <input type="text" id="modalToothShade" placeholder="e.g., A1, A2, B1, C2" maxlength="10">
              </div>

              <div class="modal-form-group">
                <label for="modalInsurance">Health Insurance Number</label>
                <textarea id="modalInsurance" placeholder="Enter health insurance number" maxlength="20"></textarea>
                <div class="char-counter" id="modalInsuranceCounter">0/20</div>
              </div>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="modal-form-section">
            <h3>📞 Contact Information</h3>
            <div class="modal-form-grid">
              <div class="modal-form-group">
                <label for="modalPhone">Phone Number</label>
                <input type="tel" id="modalPhone" placeholder="(555) 123-4567">
              </div>

              <div class="modal-form-group">
                <label for="modalEmail">Email Address</label>
                <input type="email" id="modalEmail" placeholder="patient@email.com">
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="modal-form-section">
            <h3>📝 Notes</h3>
            <div class="modal-form-group">
              <label for="modalNotes">Patient Notes</label>
              <textarea id="modalNotes" placeholder="Enter any relevant notes, observations, preferences, or special instructions for this patient" rows="4" maxlength="2048"></textarea>
              <div class="char-counter" id="modalNotesCounter">0/2048</div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="modal-btn modal-btn-secondary" onclick="clearPatientModal()">Clear Form</button>
            <button type="submit" class="modal-btn modal-btn-primary">➕ Create Patient</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let selectedTeeth = [];
    let selectedPriority = 2;
    let uploadedFilesData = [];

    // Check if doctor is selected and enable/disable patient and practice fields
    function checkDoctorSelection() {
      const doctorValue = document.getElementById('doctorName').value.trim();
      const patientInput = document.getElementById('patientName');
      const practiceInput = document.getElementById('practiceName');
      const patientSelect = document.getElementById('patientSelect');
      const practiceSelect = document.getElementById('practiceSelect');
      const addPatientBtn = document.getElementById('addPatientBtn');
      
      if (doctorValue.length > 0) {
        // Enable patient and practice fields
        patientInput.disabled = false;
        practiceInput.disabled = false;
        patientSelect.classList.remove('disabled-select');
        practiceSelect.classList.remove('disabled-select');
        
        // Update placeholders
        patientInput.placeholder = 'Select or type patient name';
        practiceInput.placeholder = 'Select or type practice name';
        
        // Enable Add Patient button
        addPatientBtn.disabled = false;
        addPatientBtn.style.opacity = '1';
        addPatientBtn.style.cursor = 'pointer';
        
        // Simulate loading patients and practices for the selected doctor
        // In a real application, this would fetch data from the server
        updatePatientAndPracticeList(doctorValue);
      } else {
        // Disable patient and practice fields
        patientInput.disabled = true;
        practiceInput.disabled = true;
        patientSelect.classList.add('disabled-select');
        practiceSelect.classList.add('disabled-select');
        
        // Clear values
        patientInput.value = '';
        practiceInput.value = '';
        
        // Update placeholders
        patientInput.placeholder = 'First select a doctor';
        practiceInput.placeholder = 'First select a doctor';
        
        // Disable Add Patient button
        addPatientBtn.disabled = true;
        addPatientBtn.style.opacity = '0.5';
        addPatientBtn.style.cursor = 'not-allowed';
      }
      
      // Check form state for reset button
      checkFormState();
    }

    function updatePatientAndPracticeList(doctorName) {
      // This function simulates updating the patient and practice lists based on the selected doctor
      // In a real application, this would make an API call to fetch the doctor's patients and associated practices
      
      // You could customize the lists here based on the doctor selected
      // For now, we'll just keep the existing options
      
      // Optionally, you could update the dropdown options dynamically:
      // const patientDropdown = document.querySelector('#patientSelect .custom-select-dropdown');
      // patientDropdown.innerHTML = ''; // Clear existing options
      // Add new options based on the doctor...
    }

    // Custom dropdown functions
    function toggleDropdown(selectId) {
      const select = document.getElementById(selectId);
      
      // Don't open if disabled
      if (select.classList.contains('disabled-select')) {
        return;
      }
      
      const allSelects = document.querySelectorAll('.custom-select');
      
      // Close all other dropdowns
      allSelects.forEach(s => {
        if (s.id !== selectId) {
          s.classList.remove('open');
        }
      });
      
      // Toggle current dropdown
      select.classList.toggle('open');
      
      // Reset filter to show all options
      const options = select.querySelectorAll('.custom-select-option');
      options.forEach(opt => opt.classList.remove('hidden'));
    }

    function selectOption(selectId, value) {
      const select = document.getElementById(selectId);
      const input = select.querySelector('.custom-select-input');
      
      // Set the value
      input.value = value;
      
      // Close dropdown
      select.classList.remove('open');
      
      // Mark selected option
      const options = select.querySelectorAll('.custom-select-option');
      options.forEach(opt => {
        if (opt.textContent === value) {
          opt.classList.add('selected');
        } else {
          opt.classList.remove('selected');
        }
      });
      
      // If doctor was selected, check and enable other fields
      if (selectId === 'doctorSelect') {
        checkDoctorSelection();
      }
      
      // Check form state for reset button
      checkFormState();
      
      // Trigger input event for any dependent logic
      input.dispatchEvent(new Event('input'));
    }

    function filterDropdown(selectId) {
      const select = document.getElementById(selectId);
      
      // Don't filter if disabled
      if (select.classList.contains('disabled-select')) {
        return;
      }
      
      const input = select.querySelector('.custom-select-input');
      const filter = input.value.toLowerCase();
      const options = select.querySelectorAll('.custom-select-option');
      
      options.forEach(opt => {
        const text = opt.textContent.toLowerCase();
        if (text.includes(filter)) {
          opt.classList.remove('hidden');
        } else {
          opt.classList.add('hidden');
        }
      });
      
      // Open dropdown when typing
      if (filter.length > 0 && !select.classList.contains('disabled-select')) {
        select.classList.add('open');
      }
      
      // Check form state for reset button
      checkFormState();
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.custom-select')) {
        document.querySelectorAll('.custom-select').forEach(select => {
          select.classList.remove('open');
        });
      }
    });

    // Check form state to enable/disable reset button
    function checkFormState() {
      const resetBtn = document.getElementById('resetBtn');
      
      // Check if any form fields have values
      const hasContent = 
        document.getElementById('doctorName').value ||
        document.getElementById('patientName').value ||
        document.getElementById('practiceName').value ||
        document.getElementById('itemType').value ||
        document.getElementById('material').value ||
        document.getElementById('shade').value ||
        document.getElementById('deadline').value ||
        document.getElementById('price').value ||
        document.getElementById('paymentStatus').value ||
        document.getElementById('notes').value ||
        document.getElementById('deliveryAddress').value ||
        selectedTeeth.length > 0 ||
        uploadedFilesData.length > 0 ||
        selectedPriority !== 2;
      
      // Enable/disable reset button
      resetBtn.disabled = !hasContent;
    }

    function selectPriority(priority, element) {
      document.querySelectorAll('.priority-option').forEach(opt => opt.classList.remove('selected'));
      element.classList.add('selected');
      document.getElementById('priorityLevel').value = priority;
      selectedPriority = priority;
      checkFormState();
    }

    function toggleTooth(toothNumber, element) {
      const index = selectedTeeth.indexOf(toothNumber);
      
      if (index > -1) {
        selectedTeeth.splice(index, 1);
        element.classList.remove('selected');
      } else {
        selectedTeeth.push(toothNumber);
        element.classList.add('selected');
      }
      
      updateSelectedTeethDisplay();
      checkFormState();
    }

    function updateSelectedTeethDisplay() {
      const display = document.getElementById('selectedTeeth');
      const list = document.getElementById('selectedTeethList');
      const input = document.getElementById('toothNumbers');
      
      if (selectedTeeth.length > 0) {
        display.style.display = 'block';
        list.textContent = selectedTeeth.sort((a, b) => a - b).join(', ');
        input.value = selectedTeeth.join(',');
      } else {
        display.style.display = 'none';
        input.value = '';
      }
    }

    function handleFileUpload(input) {
      const files = input.files;
      const container = document.getElementById('uploadedFiles');
      
      if (files.length === 0) return;
      
      Array.from(files).forEach((file, index) => {
        uploadedFilesData.push(file);
      });
      
      displayUploadedFiles();
      checkFormState();
    }

    function displayUploadedFiles() {
      const container = document.getElementById('uploadedFiles');
      container.innerHTML = '';
      
      if (uploadedFilesData.length === 0) return;
      
      const filesTitle = document.createElement('h4');
      filesTitle.textContent = `📎 Uploaded Files (${uploadedFilesData.length})`;
      filesTitle.style.marginBottom = '15px';
      filesTitle.style.color = '#003049';
      container.appendChild(filesTitle);
      
      uploadedFilesData.forEach((file, index) => {
        let icon = '📄';
        const fileType = file.type.toLowerCase();
        const fileName = file.name.toLowerCase();
        
        if (fileType.includes('image') || fileName.includes('photo')) {
          icon = '📷';
        } else if (fileName.includes('xray') || fileType.includes('dicom')) {
          icon = '🔬';
        } else if (fileType.includes('pdf')) {
          icon = '📄';
        }
        
        const fileDiv = document.createElement('div');
        fileDiv.className = 'uploaded-file';
        fileDiv.innerHTML = `
          <div class="file-info">
            <span class="file-icon">${icon}</span>
            <div class="file-details">
              <span class="file-name">${file.name}</span>
              <span class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
            </div>
          </div>
          <button type="button" class="file-remove" onclick="removeFile(${index})">Remove</button>
        `;
        container.appendChild(fileDiv);
      });
    }

    function removeFile(index) {
      uploadedFilesData.splice(index, 1);
      displayUploadedFiles();
      
      if (uploadedFilesData.length === 0) {
        document.getElementById('uploadedFiles').innerHTML = '';
      }
      
      checkFormState();
    }

    function saveDraft() {
      const autoSave = document.getElementById('autoSave');
      autoSave.classList.add('show');
      
      const formData = {
        doctor: document.getElementById('doctorName').value,
        patient: document.getElementById('patientName').value,
        practice: document.getElementById('practiceName').value,
        itemType: document.getElementById('itemType').value,
        material: document.getElementById('material').value,
        shade: document.getElementById('shade').value,
        priority: selectedPriority,
        selectedTeeth: selectedTeeth,
        deadline: document.getElementById('deadline').value,
        price: document.getElementById('price').value,
        paymentStatus: document.getElementById('paymentStatus').value,
        notes: document.getElementById('notes').value,
        deliveryAddress: document.getElementById('deliveryAddress').value
      };
      
      localStorage.setItem('dentalCaseDraft', JSON.stringify(formData));
      
      setTimeout(() => {
        autoSave.classList.remove('show');
      }, 2000);
    }

    function loadDraft() {
      const savedDraft = localStorage.getItem('dentalCaseDraft');
      if (savedDraft) {
        const formData = JSON.parse(savedDraft);
        
        document.getElementById('doctorName').value = formData.doctor || '';
        
        // Check doctor selection first to enable other fields if needed
        if (formData.doctor) {
          checkDoctorSelection();
        }
        
        document.getElementById('patientName').value = formData.patient || '';
        document.getElementById('practiceName').value = formData.practice || '';
        document.getElementById('itemType').value = formData.itemType || '';
        document.getElementById('material').value = formData.material || '';
        document.getElementById('shade').value = formData.shade || '';
        document.getElementById('deadline').value = formData.deadline || '';
        document.getElementById('price').value = formData.price || '';
        document.getElementById('paymentStatus').value = formData.paymentStatus || '';
        document.getElementById('notes').value = formData.notes || '';
        document.getElementById('deliveryAddress').value = formData.deliveryAddress || '';
        
        if (formData.selectedTeeth && formData.selectedTeeth.length > 0) {
          selectedTeeth = formData.selectedTeeth;
          selectedTeeth.forEach(tooth => {
            const toothElements = document.querySelectorAll('.tooth-number');
            toothElements.forEach(el => {
              if (el.textContent === tooth.toString()) {
                el.classList.add('selected');
              }
            });
          });
          updateSelectedTeethDisplay();
        }
        
        if (formData.priority) {
          const priorityElements = document.querySelectorAll('.priority-option');
          priorityElements.forEach(el => {
            if ((formData.priority === 2 && el.classList.contains('priority-normal')) ||
                (formData.priority === 4 && el.classList.contains('priority-urgent'))) {
              selectPriority(formData.priority, el);
            }
          });
        }
        
        checkFormState();
      }
    }

    function resetForm() {
      if (confirm('Are you sure you want to reset the page? This will reload the entire page and all entered data will be lost.')) {
        // Clear localStorage before reloading
        localStorage.removeItem('dentalCaseDraft');
        // Reset the patient and practice fields to disabled state
        document.getElementById('patientName').disabled = true;
        document.getElementById('practiceName').disabled = true;
        document.getElementById('patientSelect').classList.add('disabled-select');
        document.getElementById('practiceSelect').classList.add('disabled-select');
        document.getElementById('addPatientBtn').disabled = true;
        // Reload the entire page (true forces reload from server, not cache)
        window.location.reload(true);
      }
    }

    function goBack() {
      if (confirm('Are you sure you want to leave? Any unsaved changes will be lost.')) {
        window.history.back();
      }
    }

    // Form submission
    document.getElementById('newCaseForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const patient = document.getElementById('patientName').value;
      const doctor = document.getElementById('doctorName').value;
      const practice = document.getElementById('practiceName').value;
      const itemType = document.getElementById('itemType').value;
      const teeth = document.getElementById('toothNumbers').value;
      
      if (!patient || !doctor || !practice || !itemType || !teeth) {
        alert('⚠️ Please fill in all required fields marked with *');
        return;
      }
      
      if (selectedTeeth.length === 0) {
        alert('⚠️ Please select at least one tooth');
        return;
      }
      
      localStorage.removeItem('dentalCaseDraft');
      
      alert(`✅ Case created successfully!\n\n` +
            `Patient: ${patient}\n` +
            `Doctor: ${doctor}\n` +
            `Practice: ${practice}\n` +
            `Item Type: ${itemType}\n` +
            `Teeth: ${selectedTeeth.join(', ')}\n` +
            `Priority: ${selectedPriority === 2 ? 'Normal' : 'Urgent'}\n` +
            `Files Uploaded: ${uploadedFilesData.length}\n\n` +
            `The case has been assigned a number and the doctor has been notified.`);
    });

    // Patient Modal Functions
    function openPatientModal() {
      // Check if doctor is selected
      const doctorValue = document.getElementById('doctorName').value.trim();
      if (!doctorValue) {
        alert('⚠️ Please select a doctor first before adding a patient.');
        document.getElementById('doctorName').focus();
        return;
      }
      
      document.getElementById('patientModal').style.display = 'block';
      document.getElementById('modalFirstName').focus();
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closePatientModal() {
      document.getElementById('patientModal').style.display = 'none';
      document.body.style.overflow = 'auto'; // Restore scrolling
      // Reset form for next use
      document.getElementById('newPatientModalForm').reset();
      resetModalCounters();
      // Reset alerts
      document.getElementById('modalSuccessAlert').style.display = 'none';
      document.getElementById('modalInfoAlert').style.display = 'block';
    }

    function clearPatientModal() {
      if (confirm('Are you sure you want to clear all entered information?')) {
        document.getElementById('newPatientModalForm').reset();
        resetModalCounters();
        // Focus back on first name field
        document.getElementById('modalFirstName').focus();
      }
    }

    function resetModalCounters() {
      document.getElementById('modalInsuranceCounter').textContent = '0/20';
      document.getElementById('modalInsuranceCounter').style.color = '#197CAE';
      document.getElementById('modalNotesCounter').textContent = '0/2048';
      document.getElementById('modalNotesCounter').style.color = '#197CAE';
    }

    function formatModalPhoneNumber(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.length >= 6) {
        value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
      } else if (value.length >= 3) {
        value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
      }
      input.value = value;
    }

    // Modal form submission
    document.getElementById('newPatientModalForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Collect patient data
      const patientData = {
        firstName: document.getElementById('modalFirstName').value,
        lastName: document.getElementById('modalLastName').value,
        dateOfBirth: document.getElementById('modalDateOfBirth').value,
        gender: document.getElementById('modalGender').value,
        toothShade: document.getElementById('modalToothShade').value,
        insurance: document.getElementById('modalInsurance').value,
        phone: document.getElementById('modalPhone').value,
        email: document.getElementById('modalEmail').value,
        notes: document.getElementById('modalNotes').value
      };
      
      // Create patient display string
      let patientDisplay = `${patientData.firstName} ${patientData.lastName}`;
      if (patientData.dateOfBirth) {
        patientDisplay += ` - DOB: ${patientData.dateOfBirth}`;
      }
      
      // Add new patient to the dropdown list
      const patientDropdown = document.querySelector('#patientSelect .custom-select-dropdown');
      
      // Check if patient already exists
      const existingOptions = patientDropdown.querySelectorAll('.custom-select-option');
      let patientExists = false;
      existingOptions.forEach(option => {
        if (option.textContent === patientDisplay) {
          patientExists = true;
        }
      });
      
      if (!patientExists) {
        // Create new option element
        const newOption = document.createElement('div');
        newOption.className = 'custom-select-option new-patient';
        newOption.onclick = function() { selectOption('patientSelect', patientDisplay); };
        newOption.textContent = patientDisplay;
        
        // Add to the top of the list
        patientDropdown.insertBefore(newOption, patientDropdown.firstChild);
        
        // Also store patient data (in a real app, this would be saved to database)
        if (!window.patientDatabase) {
          window.patientDatabase = [];
        }
        window.patientDatabase.push({
          id: Date.now(), // Simple ID generation
          display: patientDisplay,
          data: patientData,
          createdAt: new Date().toISOString()
        });
        
        // Remove "new" indicator from other patients after 5 seconds
        setTimeout(() => {
          newOption.classList.remove('new-patient');
        }, 5000);
      }
      
      // Automatically select the newly created patient
      selectOption('patientSelect', patientDisplay);
      
      // Show success message
      document.getElementById('modalInfoAlert').style.display = 'none';
      document.getElementById('modalSuccessAlert').style.display = 'block';
      document.getElementById('modalSuccessAlert').innerHTML = `✅ Patient "${patientDisplay}" has been created and added to the list!`;
      
      // Log patient creation (in real app, this would be an API call)
      console.log('New patient created:', patientData);
      console.log('Patient database:', window.patientDatabase);
      
      // Close modal after delay
      setTimeout(() => {
        closePatientModal();
        // Reset success message for next time
        document.getElementById('modalSuccessAlert').style.display = 'none';
        document.getElementById('modalSuccessAlert').innerHTML = '✅ New patient profile created successfully!';
        document.getElementById('modalInfoAlert').style.display = 'block';
        
        // Show confirmation in main form
        const autoSave = document.getElementById('autoSave');
        autoSave.textContent = `✅ Patient "${patientData.firstName} ${patientData.lastName}" added successfully`;
        autoSave.classList.add('show');
        setTimeout(() => {
          autoSave.classList.remove('show');
          autoSave.textContent = '✅ Draft saved automatically';
        }, 3000);
      }, 2000);
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('patientModal');
      if (event.target == modal) {
        closePatientModal();
      }
    }

    // Auto-save functionality
    setInterval(() => {
      if (document.getElementById('doctorName').value || 
          document.getElementById('patientName').value || 
          selectedTeeth.length > 0) {
        saveDraft();
      }
    }, 30000);

    // Add input event listeners for form state checking
    document.addEventListener('DOMContentLoaded', function() {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('deadline').min = tomorrow.toISOString().split('T')[0];
      
      // Initialize patient and practice fields as disabled
      checkDoctorSelection();
      
      // Load any saved draft
      loadDraft();
      
      // Add event listeners for form state checking
      const formInputs = document.querySelectorAll('input, select, textarea');
      formInputs.forEach(input => {
        input.addEventListener('input', checkFormState);
        input.addEventListener('change', checkFormState);
      });
      
      // Add drag and drop functionality
      const uploadArea = document.querySelector('.file-upload-area');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight(e) {
        uploadArea.style.background = '#e8f3ff';
        uploadArea.style.borderColor = '#003049';
      }
      
      function unhighlight(e) {
        uploadArea.style.background = 'white';
        uploadArea.style.borderColor = '#197CAE';
      }
      
      uploadArea.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        Array.from(files).forEach(file => {
          uploadedFilesData.push(file);
        });
        
        displayUploadedFiles();
        checkFormState();
      }

      // Setup modal character counters
      const modalInsurance = document.getElementById('modalInsurance');
      const modalInsuranceCounter = document.getElementById('modalInsuranceCounter');
      modalInsurance.addEventListener('input', function() {
        const currentLength = this.value.length;
        modalInsuranceCounter.textContent = `${currentLength}/20`;
        
        if (currentLength > 18) {
          modalInsuranceCounter.style.color = '#dc3545';
        } else if (currentLength > 14) {
          modalInsuranceCounter.style.color = '#856404';
        } else {
          modalInsuranceCounter.style.color = '#197CAE';
        }
      });

      const modalNotes = document.getElementById('modalNotes');
      const modalNotesCounter = document.getElementById('modalNotesCounter');
      modalNotes.addEventListener('input', function() {
        const currentLength = this.value.length;
        modalNotesCounter.textContent = `${currentLength}/2048`;
        
        if (currentLength > 1800) {
          modalNotesCounter.style.color = '#dc3545';
        } else if (currentLength > 1400) {
          modalNotesCounter.style.color = '#856404';
        } else {
          modalNotesCounter.style.color = '#197CAE';
        }
      });

      // Phone number formatting for modal
      const modalPhone = document.getElementById('modalPhone');
      modalPhone.addEventListener('input', function() {
        formatModalPhoneNumber(this);
      });
    });
  </script>
</body>
</html>